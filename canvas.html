<!DOCTYPE html>
  <html>
    <!-- reference for code: https://stackoverflow.com/questions/2368784/draw-on-html5-canvas-using-a-mouse -->
	    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@0.10.0"> </script>
	    <script type="module">

      import * as tf from "@tensorflow/tfjs";
      //load the model
      model = tf.loadModel('http://localhost/AML_Project/model/model.json');

	    var canvas, ctx, flag = false,
  		prevX = 0,
  		currX = 0,
  		prevY = 0,
  		currY = 0,
  		dot_flag = false;

  	  var x = "black", y = 2;

	    strokes = []

	    function init() {
    		canvas = document.getElementById('can');
    		ctx = canvas.getContext("2d");
    		w = canvas.width;
    		h = canvas.height;

    		canvas.addEventListener("mousemove", function (e) {
    		    findxy('move', e)
    		}, false);
    		canvas.addEventListener("mousedown", function (e) {
    		    findxy('down', e)
    		}, false);
    		canvas.addEventListener("mouseup", function (e) {
    		    findxy('up', e)
    		}, false);
    		canvas.addEventListener("mouseout", function (e) {
    		    findxy('out', e)
    		}, false);
	    }

	    function draw() {
    		ctx.beginPath();
    		ctx.moveTo(prevX, prevY);
    		ctx.lineTo(currX, currY);
    		ctx.strokeStyle = x;
    		ctx.lineWidth = y;
    		ctx.stroke();
    		ctx.closePath();
	    }

	    function erase() {
    		var m = confirm("Want to clear");
    		if (m) {
    		    ctx.clearRect(0, 0, w, h);
    		    document.getElementById("canvasimg").style.display = "none";
    		}
    		strokes = [];
	    }

	    function findxy(res, e) {
    		if (res == 'down') {
    		    prevX = currX;
    		    prevY = currY;
    		    currX = e.clientX - canvas.offsetLeft;
    		    currY = e.clientY - canvas.offsetTop;

    		    flag = true;
    		    dot_flag = true;
    		    if (dot_flag) {
    		        ctx.beginPath();
    		        ctx.fillStyle = x;
    		        strokes.push([prevX-currX, prevY-currY, 0])
    		        ctx.fillRect(currX, currY, 2, 2);
    		        ctx.closePath();
    		        dot_flag = false;
    		    }
    		}
    		if (res == 'up') {
    		    strokes[strokes.length-1][2] = 1;
    		    flag = false;
    		}
    		if(res == "out")
    		{
    		  flag = false;
    		}
    		if (res == 'move') {
    		    if (flag) {
    		        prevX = currX;
    		        prevY = currY;
    		        currX = e.clientX - canvas.offsetLeft;
    		        currY = e.clientY - canvas.offsetTop;
    		        strokes.push([prevX-currX, prevY-currY, 0])
    		        draw();
    		    }
    		}
	    }

	    function predict_sketch()
	    {
	      //need to send strokes to python function for testing.

        var test_data = convert_data(strokes);
        var encoder_input = [], decoder_input = []
        encoder_input.push(test_data[0].slice(1,test_data[0].length));
        decoder_input.push(test_data[0].slice(0,test_data[0].length-1));
        const pred = model.predict([encoder_input,decoder_input]).dataSync();
	    }

      //function to preprocess data and convert into 5 stroke format
	    function convert_data(data)
	    {
        start_stroke_token = [0,0,1,0,0];
        result = [[]];
        for (var i = 0; i < strokes.length; i++) {
          result[0][i] = strokes[i];
          var t = result[0][i][2];
          result[0][i].splice(2,0,1-t);
          result[0][i].push(0);
        }
        result[0].unshift(start_stroke_token);
        return tf.convert_to_tensor(result,dtype = tf.float32);
	    }
	    </script>
    <body onload="init()">
        <canvas id="can" width="400" height="400" style="position:absolute;top:10%;left:10%;border:2px solid;"></canvas>
        <img id="canvasimg" style="position:absolute;top:10%;left:52%;" style="display:none;">
        <input type="button" value="CLEAR" id="clr" size="23" onclick="erase()" style="position:absolute;top:80%;left:5%;">
        <input type="button" onclick="setTimeout(predict_sketch,5050)" value="START">
    </body>
    </html>
